<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø°ÙƒÙŠ | ØªÙ†Ø¸ÙŠÙ ØªØ§Ù… Ù„Ù„Ø§Ø³Ù…</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(145deg, #f0f5fe 0%, #e9f0fa 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(0,20,50,0.15), 0 4px 12px rgba(0,0,0,0.05);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #0b2b4f;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 i {
            color: #2a6df4;
            font-size: 2rem;
        }
        .sub {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.1rem;
            border-right: 5px solid #2a6df4;
            padding-right: 15px;
            background: rgba(42,109,244,0.05);
            border-radius: 0 20px 20px 0;
        }

        /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± */
        .live-preview {
            background: #1a2639;
            color: #ffffff;
            padding: 20px 25px;
            border-radius: 60px 20px 60px 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 2px solid #b3d0ff;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }
        .live-preview i {
            font-size: 2.5rem;
            color: #ffd966;
            filter: drop-shadow(0 0 5px #ffb700);
        }
        .preview-text {
            flex: 1;
            font-size: 1.4rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            min-height: 4rem;
            background: rgba(255,255,255,0.1);
            border-radius: 50px;
            padding: 10px 25px;
            border: 1px solid #4a5c7c;
            font-family: 'Cairo', monospace;
            word-break: break-word;
        }
        .speech-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #55ef6b;
            box-shadow: 0 0 10px #00ff40;
            transition: 0.2s;
        }
        .speech-indicator.listening {
            background: #ff3b3b;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 25px;
            justify-content: center;
        }
        .btn {
            font-family: 'Cairo', sans-serif;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 8px 16px rgba(0,30,60,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .btn i { font-size: 1.3rem; }
        .btn-primary {
            background: #0a2a44;
            color: white;
            flex: 1 1 auto;
        }
        .btn-primary:hover { background: #123b60; transform: translateY(-3px); }
        .btn-success {
            background: #1e7e34;
            color: white;
        }
        .btn-success:hover { background: #2b9542; transform: translateY(-3px); }
        .btn-danger {
            background: #b13e3e;
            color: white;
        }
        .btn-danger:hover { background: #c44545; transform: translateY(-3px); }
        .btn-outline {
            background: white;
            color: #0a2a44;
            border: 2px solid #0a2a44;
        }
        .btn-outline:hover { background: #e8f0fe; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-wrapper {
            background: white;
            border-radius: 32px;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            border: 1px solid #cfdff5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
            min-width: 900px;
        }
        th {
            background: #f2f7ff;
            color: #0b2b4f;
            font-weight: 700;
            padding: 16px 8px;
            font-size: 1.1rem;
            border-bottom: 3px solid #8db6f0;
            white-space: nowrap;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #d9e6ff;
            text-align: center;
            vertical-align: middle;
            background-color: white;
        }
        td[contenteditable="true"] {
            background-color: #fffcf0;
            outline: none;
            transition: 0.1s;
            cursor: text;
            min-width: 100px;
        }
        td[contenteditable="true"]:hover {
            background-color: #fff6dd;
        }
        td[contenteditable="true"]:focus {
            background-color: #fff0cc;
            box-shadow: inset 0 0 0 2px #2a6df4;
        }
        .delete-cell {
            text-align: center;
        }
        .delete-row {
            background: none;
            border: none;
            color: #b13e3e;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 30px;
            transition: 0.2s;
        }
        .delete-row:hover {
            background: #ffe2e2;
            color: #a00;
            transform: scale(1.2);
        }
        .index {
            font-weight: 700;
            color: #2a6df4;
        }
        .footer-note {
            margin-top: 20px;
            text-align: left;
            color: #2c3e50;
            font-size: 0.95rem;
            background: rgba(255,255,255,0.5);
            padding: 10px 20px;
            border-radius: 60px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1><i class="fas fa-microphone-alt"></i> Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø°ÙƒÙŠ | ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</h1>
    <div class="sub">Ø§Ù„Ø¢Ù† Ø§Ù„Ø§Ø³Ù… ÙŠØ¨Ù‚Ù‰ Ù†Ø¸ÙŠÙØ§Ù‹ Ø¯ÙˆÙ† Ø£ÙŠ ÙƒÙ„Ù…Ø§Øª Ø²Ø§Ø¦Ø¯Ø© Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù…</div>

    <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
    <div class="live-preview">
        <i class="fas fa-wave-square"></i>
        <div class="preview-text" id="livePreview">âºï¸ ... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</div>
        <div class="speech-indicator" id="indicator"></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="action-bar">
        <button class="btn btn-primary" id="startSpeechBtn"><i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«</button>
        <button class="btn btn-success" id="exportWordBtn"><i class="fas fa-file-word"></i> ØªØµØ¯ÙŠØ± Word</button>
        <button class="btn btn-danger" id="clearTableBtn"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-wrapper">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                    <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ 20 ØµÙØ§Ù‹ Ø¹Ø¨Ø± JS -->
            </tbody>
        </table>
    </div>
    <div class="footer-note">
        <i class="fas fa-check-circle"></i> Ù…Ø«Ø§Ù„: "Ø§Ù„Ø§Ø³Ù… Ø±Ù…Ø§Ù† ÙŠØ³Ù„Ù… Ø¨Ø§Ø¬Ø­Ù‡ Ø§Ù„Ø¹Ø¯Ø¯ 7 Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© 12345678910 Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ 779359509" â† Ø§Ù„Ø§Ø³Ù… "Ø±Ù…Ø§Ù† ÙŠØ³Ù„Ù… Ø¨Ø§Ø¬Ø­Ù‡"
    </div>
</div>

<script>
    (function() {
        // -------------------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ --------------------
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        if (!SpeechRecognition) {
            alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø£Ùˆ Edge.");
        }

        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-SA';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
        }

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
        const livePreview = document.getElementById('livePreview');
        const indicator = document.getElementById('indicator');
        const startBtn = document.getElementById('startSpeechBtn');
        const exportBtn = document.getElementById('exportWordBtn');
        const clearBtn = document.getElementById('clearTableBtn');
        const tbody = document.getElementById('tableBody');

        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø±Ù
        let isListening = false;
        let finalTranscript = '';

        // -------------------- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù€ 20 ØµÙØ§Ù‹ --------------------
        function initTable() {
            tbody.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                appendEmptyRow(i);
            }
        }
        function appendEmptyRow(index) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-index', index);
            const tdIndex = document.createElement('td');
            tdIndex.className = 'index';
            tdIndex.textContent = index;
            tr.appendChild(tdIndex);

            const tdName = document.createElement('td');
            tdName.setAttribute('contenteditable', 'true');
            tdName.setAttribute('data-field', 'name');
            tdName.textContent = '';
            tr.appendChild(tdName);

            const tdCount = document.createElement('td');
            tdCount.setAttribute('contenteditable', 'true');
            tdCount.setAttribute('data-field', 'count');
            tdCount.textContent = '';
            tr.appendChild(tdCount);

            const tdId = document.createElement('td');
            tdId.setAttribute('contenteditable', 'true');
            tdId.setAttribute('data-field', 'idCard');
            tdId.textContent = '';
            tr.appendChild(tdId);

            const tdMobile = document.createElement('td');
            tdMobile.setAttribute('contenteditable', 'true');
            tdMobile.setAttribute('data-field', 'mobile');
            tdMobile.textContent = '';
            tr.appendChild(tdMobile);

            const tdDel = document.createElement('td');
            tdDel.className = 'delete-cell';
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-row';
            delBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            delBtn.setAttribute('aria-label', 'Ø­Ø°Ù Ø§Ù„ØµÙ');
            delBtn.onclick = function() {
                const row = this.closest('tr');
                if (row) {
                    row.cells[1].textContent = '';
                    row.cells[2].textContent = '';
                    row.cells[3].textContent = '';
                    row.cells[4].textContent = '';
                }
            };
            tdDel.appendChild(delBtn);
            tr.appendChild(tdDel);

            tbody.appendChild(tr);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙÙˆÙ (Ø¥Ø°Ø§ Ø²Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø¹Ù† 20)
        function renumberRows() {
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                const indexCell = row.cells[0];
                if (indexCell) indexCell.textContent = (idx + 1);
            });
        }

        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙˆÙ„ ØµÙ ÙØ§Ø±Øº
        function findFirstEmptyRow() {
            const rows = tbody.querySelectorAll('tr');
            for (let row of rows) {
                const nameCell = row.cells[1];
                if (!nameCell || nameCell.textContent.trim() === '') {
                    return row;
                }
            }
            const newIndex = rows.length + 1;
            appendEmptyRow(newIndex);
            renumberRows();
            return tbody.lastElementChild;
        }

        // -------------------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ --------------------

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ© Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…
        function convertSpokenNumbers(text) {
            const numMap = {
                'ØµÙØ±': '0', 'ÙˆØ§Ø­Ø¯': '1', 'Ø§Ø«Ù†Ø§Ù†': '2', 'Ø§Ø«Ù†ÙŠÙ†': '2', 'Ø«Ù„Ø§Ø«Ø©': '3', 'Ø«Ù„Ø§Ø«': '3',
                'Ø£Ø±Ø¨Ø¹Ø©': '4', 'Ø£Ø±Ø¨Ø¹': '4', 'Ø®Ù…Ø³Ø©': '5', 'Ø®Ù…Ø³': '5',
                'Ø³ØªØ©': '6', 'Ø³Øª': '6', 'Ø³Ø¨Ø¹Ø©': '7', 'Ø³Ø¨Ø¹': '7',
                'Ø«Ù…Ø§Ù†ÙŠØ©': '8', 'Ø«Ù…Ø§Ù†': '8', 'ØªØ³Ø¹Ø©': '9', 'ØªØ³Ø¹': '9', 'Ø¹Ø´Ø±Ø©': '10', 'Ø¹Ø´Ø±': '10'
            };
            let newText = text;

            // Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªÙƒØ±Ø§Ø±
            const repeatPatterns = [
                { plural: 'Ø³Ø¨Ø¹Ø§Øª', digit: '7' }, { plural: 'Ø«Ù…Ø§Ù†Ø§Øª', digit: '8' }, { plural: 'ØªØ³Ø¹Ø§Øª', digit: '9' },
                { plural: 'Ø®Ù…Ø³Ø§Øª', digit: '5' }, { plural: 'Ø£Ø±Ø¨Ø¹Ø§Øª', digit: '4' }, { plural: 'Ø³ØªØ§Øª', digit: '6' }
            ];
            for (let pat of repeatPatterns) {
                const regex = new RegExp(`(\\w+)\\s+${pat.plural}`, 'g');
                newText = newText.replace(regex, (match, p1) => {
                    const numWord = p1.trim();
                    let count = parseInt(numMap[numWord] || numWord);
                    if (isNaN(count)) count = 1;
                    return pat.digit.repeat(count);
                });
            }

            newText = newText.replace(/\bØµÙØ±ÙŠÙ†\b/g, '00');
            newText = newText.replace(/\bØ³Ø¨Ø¹ØªÙŠÙ†\b/g, '77');
            newText = newText.replace(/\bØ«Ù…Ø§Ù†ÙŠØªÙŠÙ†\b/g, '88');
            newText = newText.replace(/\bØªØ³Ø¹ØªÙŠÙ†\b/g, '99');

            for (let [word, digit] of Object.entries(numMap)) {
                const wordRegex = new RegExp(`\\b${word}\\b`, 'g');
                newText = newText.replace(wordRegex, digit);
            }
            return newText;
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ù…Ø¹ÙŠÙ†
        function extractNumberWithSpaces(text, options = {}) {
            const digitsOnly = text.replace(/\s/g, '');
            const numberPattern = /[\d\s]+/g;
            let match;
            while ((match = numberPattern.exec(text)) !== null) {
                const candidate = match[0];
                const candidateDigits = candidate.replace(/\s/g, '');
                const len = candidateDigits.length;
                if (options.exactLength !== undefined && len === options.exactLength) {
                    if (options.startDigit && candidateDigits[0] === options.startDigit) {
                        return { raw: candidate, clean: candidateDigits };
                    } else if (!options.startDigit) {
                        return { raw: candidate, clean: candidateDigits };
                    }
                } else if (options.minLength !== undefined && options.maxLength !== undefined && len >= options.minLength && len <= options.maxLength) {
                    return { raw: candidate, clean: candidateDigits };
                }
            }
            return null;
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ø¯Ø¯
        function extractCount(text) {
            const countPatterns = [
                { regex: /Ø¹Ø¯Ø¯\s+(\d{1,2})/i, group: 1 },
                { regex: /Ø£ÙØ±Ø§Ø¯\s+(\d{1,2})/i, group: 1 },
                { regex: /(\d{1,2})\s*(ÙØ±Ø¯|Ø£ÙØ±Ø§Ø¯)/i, group: 1 }
            ];
            for (let pat of countPatterns) {
                const match = pat.regex.exec(text);
                if (match) {
                    return { value: match[pat.group], matchText: match[0] };
                }
            }
            // Ø±Ù‚Ù… Ù…Ù†ÙØ±Ø¯ ØµØºÙŠØ±
            const standaloneNumbers = text.match(/\b(\d{1,2})\b/g);
            if (standaloneNumbers) {
                for (let num of standaloneNumbers) {
                    if (parseInt(num) < 20) {
                        const numRegex = new RegExp(`\\b${num}\\b`);
                        const match = numRegex.exec(text);
                        if (match) {
                            return { value: num, matchText: match[0] };
                        }
                    }
                }
            }
            return null;
        }

        // -------------------- ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ø¨Ø´ÙƒÙ„ Ù‚ÙˆÙŠ --------------------
        // Ù‚Ø§Ø¦Ù…Ø© Ù…ÙˆØ³Ø¹Ø© Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
        const stopWords = [
            'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ø³Ù…', 'Ø³Ø¬Ù„', 'Ø¨Ø·Ø§Ù‚Ø©', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', 'Ø±Ù‚Ù…', 'Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø¬ÙˆØ§Ù„',
            'Ù‡ÙˆÙŠØ©', 'Ù‡Ùˆ', 'Ùˆ', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ø¹Ø¯Ø¯', 'Ø£ÙØ±Ø§Ø¯', 'Ø§ÙØ±Ø§Ø¯', 'ÙØ±Ø¯', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡', 'Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
            'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'ÙƒØ°Ø§', 'Ø§Ù„ØªØ§Ù„ÙŠ', 'Ù‡Ø°Ø§', 'Ù‡Ø°Ù‡', 'ØªÙ…', 'Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'Ø¥Ø¶Ø§ÙØ©', 'Ø­Ø°Ù'
        ];

        function cleanName(rawName) {
            let name = rawName;
            // 1. Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            name = name.replace(/\d+/g, '');
            // 2. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠØ© (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª)
            stopWords.forEach(word => {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…Ø· ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø­Ø¯ÙˆØ¯ ÙƒÙ„Ù…Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø¹Ø²ÙˆÙ„Ø©)
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                name = name.replace(regex, '');
            });
            // 3. Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ø¨Ø§Ø±Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ø«Ù„ "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡" - Ù†Ø²ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£ÙŠØ¶Ø§Ù‹
            // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ù…Ø§ ÙŠØ´Ø¨Ù‡ "Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" Ø£Ùˆ "Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø±Ù‚Ù…" Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…
            name = name.replace(/Ø±Ù‚Ù…\s+Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡?/gi, '');
            name = name.replace(/Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡?\s+Ø±Ù‚Ù…/gi, '');
            name = name.replace(/Ø±Ù‚Ù…\s+Ø§Ù„Ø¬ÙˆØ§Ù„/gi, '');
            name = name.replace(/Ø§Ù„Ø¬ÙˆØ§Ù„\s+Ø±Ù‚Ù…/gi, '');
            name = name.replace(/Ø§Ù„Ø¹Ø¯Ø¯\s+Ø±Ù‚Ù…/gi, '');
            // 4. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
            name = name.replace(/\s+/g, ' ').trim();
            return name;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø¹Ø¯Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù…)
        function extractFieldsFromText(spokenText) {
            let text = convertSpokenNumbers(spokenText);
            text = text.replace(/\s+/g, ' ').trim();

            let mobile = '', idCard = '', count = '';
            let remainingText = text;

            // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬ÙˆØ§Ù„
            const mobileMatch = extractNumberWithSpaces(remainingText, { startDigit: '7', exactLength: 9 });
            if (mobileMatch) {
                mobile = mobileMatch.clean;
                remainingText = remainingText.replace(mobileMatch.raw, '');
            }

            // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            const idMatch = extractNumberWithSpaces(remainingText, { minLength: 4, maxLength: 15 });
            if (idMatch) {
                idCard = idMatch.clean;
                remainingText = remainingText.replace(idMatch.raw, '');
            }

            // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ø¯Ø¯
            const countMatch = extractCount(remainingText);
            if (countMatch) {
                count = countMatch.value;
                remainingText = remainingText.replace(countMatch.matchText, '');
            }

            // 4. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù…: Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠØ©
            let name = cleanName(remainingText);

            return { name, count, idCard, mobile };
        }

        // -------------------- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ --------------------
        function addDataToTable(data) {
            const row = findFirstEmptyRow();
            if (row) {
                if (data.name) row.cells[1].textContent = data.name;
                if (data.count) row.cells[2].textContent = data.count;
                if (data.idCard) row.cells[3].textContent = data.idCard;
                if (data.mobile) row.cells[4].textContent = data.mobile;
            }
        }

        // -------------------- Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ --------------------
        if (recognition) {
            recognition.onstart = function() {
                isListening = true;
                indicator.classList.add('listening');
                livePreview.innerHTML = 'ğŸŸ¢ Ø£Ù†ØµØª ...';
                finalTranscript = '';
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                livePreview.innerHTML = finalTranscript + '<span style="color: #ffd966;">' + interimTranscript + '</span>';
            };

            recognition.onend = function() {
                indicator.classList.remove('listening');
                if (finalTranscript.trim() !== '') {
                    const fields = extractFieldsFromText(finalTranscript.trim());
                    addDataToTable(fields);
                    livePreview.innerHTML = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø©: ' + finalTranscript;
                } else {
                    livePreview.innerHTML = 'âºï¸ ... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†';
                }
                isListening = false;
                finalTranscript = '';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«';
            };

            recognition.onerror = function(event) {
                console.error('Ø®Ø·Ø£:', event.error);
                indicator.classList.remove('listening');
                livePreview.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + event.error;
                isListening = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«';
            };
        }

        // Ø¨Ø¯Ø¡ / Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯Ø«
        startBtn.addEventListener('click', function() {
            if (!recognition) {
                alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ');
                return;
            }
            if (isListening) {
                recognition.stop();
                startBtn.innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«';
            } else {
                recognition.start();
                startBtn.innerHTML = '<i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯Ø«';
            }
        });

        // ØªØµØ¯ÙŠØ± Word
        exportBtn.addEventListener('click', function() {
            const table = document.getElementById('dataTable');
            const htmlContent = `
            <html dir="rtl">
            <head><meta charset="UTF-8"><title>ÙƒØ´ÙˆÙØ§Øª Ø°ÙƒÙŠØ©</title>
            <style>body { font-family: 'Cairo'; } table { border-collapse: collapse; width:100%; } th { background:#2a6df4; color:white; } td,th { border:1px solid black; padding:8px; } </style>
            </head>
            <body>${table.outerHTML}</body>
            </html>`;
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ÙƒØ´ÙˆÙØ§Øª_ØµÙˆØªÙŠ.doc';
            link.click();
        });

        // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        clearBtn.addEventListener('click', function() {
            tbody.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                appendEmptyRow(i);
            }
        });

        // Ù…Ù†Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ø§Ø³Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹
        tbody.addEventListener('input', function(e) {
            const cell = e.target;
            if (cell.hasAttribute('contenteditable') && cell.getAttribute('data-field') === 'name') {
                cell.textContent = cell.textContent.replace(/\d+/g, '');
            }
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
        initTable();
    })();
</script>
</body>
</html>