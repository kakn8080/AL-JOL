<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø°ÙƒÙŠ </title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…Ø¹ ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(145deg, #f0f5fe 0%, #e9f0fa 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 1500px;
            width: 100%;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,20,50,0.15), 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #0b2b4f;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        h1 i {
            color: #2a6df4;
            font-size: 2rem;
        }
        .sub {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1rem;
            border-right: 5px solid #2a6df4;
            padding-right: 15px;
            background: rgba(42,109,244,0.05);
            border-radius: 0 20px 20px 0;
        }

        /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± */
        .live-preview {
            background: #1a2639;
            color: #ffffff;
            padding: 15px 20px;
            border-radius: 50px 20px 50px 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 2px solid #b3d0ff;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .live-preview i {
            font-size: 2rem;
            color: #ffd966;
            filter: drop-shadow(0 0 5px #ffb700);
        }
        .preview-text {
            flex: 1;
            font-size: 1.2rem;
            font-weight: 500;
            min-height: 3rem;
            background: rgba(255,255,255,0.1);
            border-radius: 40px;
            padding: 8px 20px;
            border: 1px solid #4a5c7c;
            font-family: 'Cairo', monospace;
            word-break: break-word;
        }
        .speech-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #55ef6b;
            box-shadow: 0 0 10px #00ff40;
            transition: 0.2s;
        }
        .speech-indicator.listening {
            background: #ff3b3b;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ù„Ù…Ø³Ø© ÙƒØ¨ÙŠØ±Ø© Ù„Ù„Ø¬ÙˆØ§Ù„) */
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .btn {
            font-family: 'Cairo', sans-serif;
            border: none;
            padding: 16px 22px;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 8px 16px rgba(0,30,60,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            min-width: 160px;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .btn i { font-size: 1.4rem; }
        .btn-primary {
            background: #0a2a44;
            color: white;
            flex: 1 1 auto;
        }
        .btn-primary:hover { background: #123b60; transform: translateY(-3px); }
        .btn-success {
            background: #1e7e34;
            color: white;
        }
        .btn-success:hover { background: #2b9542; transform: translateY(-3px); }
        .btn-danger {
            background: #b13e3e;
            color: white;
        }
        .btn-danger:hover { background: #c44545; transform: translateY(-3px); }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ Ù„Ù„Ø¬ÙˆØ§Ù„ */
        .table-wrapper {
            background: white;
            border-radius: 25px;
            overflow-x: auto;
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            border: 1px solid #cfdff5;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            min-width: 1200px; /* ØªÙˆØ³ÙŠØ¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        }
        th {
            background: #f2f7ff;
            color: #0b2b4f;
            font-weight: 700;
            padding: 16px 8px;
            font-size: 1rem;
            border-bottom: 3px solid #8db6f0;
            white-space: nowrap;
        }
        td {
            padding: 10px 5px;
            border-bottom: 1px solid #d9e6ff;
            text-align: center;
            vertical-align: middle;
            background-color: white;
        }
        td[contenteditable="true"] {
            background-color: #fffcf0;
            outline: none;
            transition: 0.1s;
            cursor: text;
            min-width: 100px;
        }
        td[contenteditable="true"]:hover {
            background-color: #fff6dd;
        }
        td[contenteditable="true"]:focus {
            background-color: #fff0cc;
            box-shadow: inset 0 0 0 2px #2a6df4;
        }
        .delete-cell {
            text-align: center;
        }
        .delete-row {
            background: none;
            border: none;
            color: #b13e3e;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 40px;
            transition: 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .delete-row:hover {
            background: #ffe2e2;
            color: #a00;
            transform: scale(1.2);
        }
        .index {
            font-weight: 700;
            color: #2a6df4;
        }
        .footer-note {
            margin-top: 20px;
            text-align: left;
            color: #2c3e50;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.5);
            padding: 10px 20px;
            border-radius: 60px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1><i class="fas fa-microphone-alt"></i> Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø°ÙƒÙŠ </h1>
    <div class="sub">ØªØ­Ø¯Ø«: Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø«Ù… Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø©ØŒ Ø«Ù… Ø§Ù„Ø¹Ø¯Ø¯ØŒ Ø«Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŒ Ø«Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ â€” ÙˆØ³Ù†Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø£Ù…Ø§ÙƒÙ†Ù‡Ø§</div>

    <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
    <div class="live-preview">
        <i class="fas fa-wave-square"></i>
        <div class="preview-text" id="livePreview">âºï¸ ... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</div>
        <div class="speech-indicator" id="indicator"></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="action-bar">
        <button class="btn btn-primary" id="startSpeechBtn"><i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«</button>
        <button class="btn btn-success" id="exportWordBtn"><i class="fas fa-file-word"></i> ØªØµØ¯ÙŠØ± Word</button>
        <button class="btn btn-danger" id="clearTableBtn"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-wrapper">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø©</th>
                    <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ 20 ØµÙØ§Ù‹ Ø¹Ø¨Ø± JS -->
            </tbody>
        </table>
    </div>
    <div class="footer-note">
        <i class="fas fa-check-circle"></i> Ù…Ø«Ø§Ù„: "Ø§Ù„Ø§Ø³Ù… Ø¬Ø¹ÙØ± Ù†Ø¬ÙŠØ¨ Ø¨Ù† Ø´Ù‡Ø¨Ù„ Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø© Ù…Ù†Ù‰ Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø¹ÙˆØ§Ù‚Ø¨ÙŠ Ø§Ù„Ø¹Ø¯Ø¯ 4 Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© 080499235 Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ 781899624"
    </div>
</div>

<script>
    (function() {
        // -------------------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ --------------------
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        if (!SpeechRecognition) {
            alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø£Ùˆ Edge.");
        }

        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-SA';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
        }

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
        const livePreview = document.getElementById('livePreview');
        const indicator = document.getElementById('indicator');
        const startBtn = document.getElementById('startSpeechBtn');
        const exportBtn = document.getElementById('exportWordBtn');
        const clearBtn = document.getElementById('clearTableBtn');
        const tbody = document.getElementById('tableBody');

        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø±Ù
        let isListening = false;
        let finalTranscript = '';

        // -------------------- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù€ 20 ØµÙØ§Ù‹ (Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯) --------------------
        function initTable() {
            tbody.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                appendEmptyRow(i);
            }
        }
        function appendEmptyRow(index) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-index', index);
            const tdIndex = document.createElement('td');
            tdIndex.className = 'index';
            tdIndex.textContent = index;
            tr.appendChild(tdIndex);

            // Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬
            const tdName = document.createElement('td');
            tdName.setAttribute('contenteditable', 'true');
            tdName.setAttribute('data-field', 'name');
            tdName.textContent = '';
            tr.appendChild(tdName);

            // Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø©
            const tdWife = document.createElement('td');
            tdWife.setAttribute('contenteditable', 'true');
            tdWife.setAttribute('data-field', 'wife');
            tdWife.textContent = '';
            tr.appendChild(tdWife);

            // Ø§Ù„Ø¹Ø¯Ø¯
            const tdCount = document.createElement('td');
            tdCount.setAttribute('contenteditable', 'true');
            tdCount.setAttribute('data-field', 'count');
            tdCount.textContent = '';
            tr.appendChild(tdCount);

            // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            const tdId = document.createElement('td');
            tdId.setAttribute('contenteditable', 'true');
            tdId.setAttribute('data-field', 'idCard');
            tdId.textContent = '';
            tr.appendChild(tdId);

            // Ø§Ù„Ø¬ÙˆØ§Ù„
            const tdMobile = document.createElement('td');
            tdMobile.setAttribute('contenteditable', 'true');
            tdMobile.setAttribute('data-field', 'mobile');
            tdMobile.textContent = '';
            tr.appendChild(tdMobile);

            // Ø­Ø°Ù
            const tdDel = document.createElement('td');
            tdDel.className = 'delete-cell';
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-row';
            delBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            delBtn.setAttribute('aria-label', 'Ø­Ø°Ù Ø§Ù„ØµÙ');
            delBtn.onclick = function() {
                const row = this.closest('tr');
                if (row) {
                    row.cells[1].textContent = ''; // Ø§Ù„Ø§Ø³Ù…
                    row.cells[2].textContent = ''; // Ø§Ù„Ø²ÙˆØ¬Ø©
                    row.cells[3].textContent = ''; // Ø§Ù„Ø¹Ø¯Ø¯
                    row.cells[4].textContent = ''; // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                    row.cells[5].textContent = ''; // Ø§Ù„Ø¬ÙˆØ§Ù„
                }
            };
            tdDel.appendChild(delBtn);
            tr.appendChild(tdDel);

            tbody.appendChild(tr);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙÙˆÙ
        function renumberRows() {
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                const indexCell = row.cells[0];
                if (indexCell) indexCell.textContent = (idx + 1);
            });
        }

        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙˆÙ„ ØµÙ ÙØ§Ø±Øº (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø®Ù„ÙŠØ© Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„)
        function findFirstEmptyRow() {
            const rows = tbody.querySelectorAll('tr');
            for (let row of rows) {
                const nameCell = row.cells[1]; // Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
                if (!nameCell || nameCell.textContent.trim() === '') {
                    return row;
                }
            }
            const newIndex = rows.length + 1;
            appendEmptyRow(newIndex);
            renumberRows();
            return tbody.lastElementChild;
        }

        // -------------------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ --------------------

        // Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const numMap = {
            'ØµÙØ±': '0', 'ÙˆØ§Ø­Ø¯': '1', 'Ø§Ø«Ù†Ø§Ù†': '2', 'Ø§Ø«Ù†ÙŠÙ†': '2', 'Ø«Ù„Ø§Ø«Ø©': '3', 'Ø«Ù„Ø§Ø«Ù‡': '3',
            'Ø§Ø±Ø¨Ø¹Ø©': '4', 'Ø§Ø±Ø¨Ø¹Ù‡': '4', 'Ø®Ù…Ø³Ø©': '5', 'Ø®Ù…Ø³Ù‡': '5',
            'Ø³ØªØ©': '6', 'Ø³ØªÙ‡': '6', 'Ø³Ø¨Ø¹Ø©': '7', 'Ø³Ø¨Ø¹Ù‡': '7',
            'Ø«Ù…Ø§Ù†ÙŠØ©': '8', 'Ø«Ù…Ø§Ù†ÙŠÙ‡': '8', 'ØªØ³Ø¹Ø©': '9', 'ØªØ³Ø¹Ù‡': '9', 'Ø¹Ø´Ø±Ø©': '10', 'Ø¹Ø´Ø±Ù‡': '10'
        };

        // Ø¯Ø§Ù„Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ù…ØªØ±Ø§ØµØ©
        function convertSpokenNumbers(text) {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø§ØµØ©
            let newText = text;
            const repeatPatterns = [
                { plural: 'Ø³Ø¨Ø¹Ø§Øª', digit: '7' }, { plural: 'Ø«Ù…Ø§Ù†Ø§Øª', digit: '8' }, { plural: 'ØªØ³Ø¹Ø§Øª', digit: '9' },
                { plural: 'Ø®Ù…Ø³Ø§Øª', digit: '5' }, { plural: 'Ø£Ø±Ø¨Ø¹Ø§Øª', digit: '4' }, { plural: 'Ø³ØªØ§Øª', digit: '6' },
                { plural: 'Ø§Ø«Ù†ÙŠÙ†Ø§Øª', digit: '2' }, { plural: 'Ø«Ù„Ø§Ø«Ø§Øª', digit: '3' }
            ];
            for (let pat of repeatPatterns) {
                const regex = new RegExp(`(\\w+)\\s+${pat.plural}`, 'g');
                newText = newText.replace(regex, (match, p1) => {
                    const numWord = p1.trim();
                    let count = parseInt(numMap[numWord] || numWord);
                    if (isNaN(count)) count = 1;
                    return pat.digit.repeat(count);
                });
            }

            // Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£ØµÙØ§Ø±
            const zeroPatterns = [
                { word: 'Ø£ØµÙØ§Ø±', digit: '0' }, { word: 'ØµÙØ±', digit: '0' }
            ];
            for (let pat of zeroPatterns) {
                const regex = new RegExp(`(\\w+)\\s+${pat.word}`, 'g');
                newText = newText.replace(regex, (match, p1) => {
                    const numWord = p1.trim();
                    let count = parseInt(numMap[numWord] || numWord);
                    if (isNaN(count)) count = 1;
                    return pat.digit.repeat(count);
                });
            }

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
            let tokens = newText.split(/(\s+)/).filter(t => t.trim().length > 0 || t === ' ');
            let result = [];
            let i = 0;
            while (i < tokens.length) {
                let token = tokens[i];
                if (token.trim() === '') {
                    result.push(token);
                    i++;
                    continue;
                }
                if (numMap.hasOwnProperty(token)) {
                    let numberStr = numMap[token];
                    i++;
                    while (i < tokens.length && numMap.hasOwnProperty(tokens[i].trim())) {
                        numberStr += numMap[tokens[i].trim()];
                        i++;
                    }
                    result.push(numberStr);
                } else {
                    result.push(token);
                    i++;
                }
            }
            return result.join('');
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ù…Ø¹ÙŠÙ† (Ø¬ÙˆØ§Ù„ / Ø¨Ø·Ø§Ù‚Ø©)
        function extractNumberWithSpaces(text, options = {}) {
            const numberPattern = /[\d\s]+/g;
            let match;
            while ((match = numberPattern.exec(text)) !== null) {
                const candidate = match[0];
                const candidateDigits = candidate.replace(/\s/g, '');
                const len = candidateDigits.length;
                if (options.exactLength !== undefined && len === options.exactLength) {
                    if (options.startDigit && candidateDigits[0] === options.startDigit) {
                        return { raw: candidate, clean: candidateDigits };
                    } else if (!options.startDigit) {
                        return { raw: candidate, clean: candidateDigits };
                    }
                } else if (options.minLength !== undefined && options.maxLength !== undefined && len >= options.minLength && len <= options.maxLength) {
                    return { raw: candidate, clean: candidateDigits };
                }
            }
            return null;
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ø¯Ø¯
        function extractCount(text) {
            const countPatterns = [
                { regex: /Ø¹Ø¯Ø¯\s+(\d{1,2})/i, group: 1 },
                { regex: /Ø£ÙØ±Ø§Ø¯\s+(\d{1,2})/i, group: 1 },
                { regex: /(\d{1,2})\s*(ÙØ±Ø¯|Ø£ÙØ±Ø§Ø¯)/i, group: 1 },
                { regex: /Ø§Ù„Ø¹Ø¯Ø¯\s+(\d{1,2})/i, group: 1 }
            ];
            for (let pat of countPatterns) {
                const match = pat.regex.exec(text);
                if (match) {
                    return { value: match[pat.group], matchText: match[0] };
                }
            }
            // Ø±Ù‚Ù… Ù…Ù†ÙØ±Ø¯ ØµØºÙŠØ±
            const standaloneNumbers = text.match(/\b(\d{1,2})\b/g);
            if (standaloneNumbers) {
                for (let num of standaloneNumbers) {
                    if (parseInt(num) < 20) {
                        const numRegex = new RegExp(`\\b${num}\\b`);
                        const match = numRegex.exec(text);
                        if (match) {
                            return { value: num, matchText: match[0] };
                        }
                    }
                }
            }
            return null;
        }

        // -------------------- ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø²ÙˆØ¬Ø©) --------------------
        const stopWords = [
            'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ø³Ù…', 'Ø³Ø¬Ù„', 'Ø¨Ø·Ø§Ù‚Ø©', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', 'Ø±Ù‚Ù…', 'Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø¬ÙˆØ§Ù„',
            'Ù‡ÙˆÙŠØ©', 'Ù‡Ùˆ', 'Ùˆ', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ø¹Ø¯Ø¯', 'Ø£ÙØ±Ø§Ø¯', 'Ø§ÙØ±Ø§Ø¯', 'ÙØ±Ø¯', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡', 'Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
            'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'ÙƒØ°Ø§', 'Ø§Ù„ØªØ§Ù„ÙŠ', 'Ù‡Ø°Ø§', 'Ù‡Ø°Ù‡', 'ØªÙ…', 'Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'Ø¥Ø¶Ø§ÙØ©', 'Ø­Ø°Ù',
            'Ø§Ù„Ø²ÙˆØ¬Ø©', 'Ø²ÙˆØ¬Ø©', 'Ø§Ù„Ø²ÙˆØ¬Ù‡', 'Ø²ÙˆØ¬Ù‡'  // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø²ÙˆØ¬Ø©
        ];

        function cleanName(rawName) {
            let name = rawName;
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            name = name.replace(/\d+/g, '');
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠØ©
            stopWords.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                name = name.replace(regex, '');
            });
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
            name = name.replace(/Ø±Ù‚Ù…\s+Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡?/gi, '');
            name = name.replace(/Ø§Ù„Ø¨Ø·Ø§Ù‚Ù‡?\s+Ø±Ù‚Ù…/gi, '');
            name = name.replace(/Ø±Ù‚Ù…\s+Ø§Ù„Ø¬ÙˆØ§Ù„/gi, '');
            name = name.replace(/Ø§Ù„Ø¬ÙˆØ§Ù„\s+Ø±Ù‚Ù…/gi, '');
            name = name.replace(/Ø§Ù„Ø¹Ø¯Ø¯\s+Ø±Ù‚Ù…/gi, '');
            name = name.replace(/Ø§Ù„Ø¹Ø¯Ø¯\s+(\d+)/gi, '');
            name = name.replace(/Ø¹Ø¯Ø¯\s+(\d+)/gi, '');
            // Ø¥Ø²Ø§Ù„Ø© "Ø§Ù„" Ø§Ù„Ù…Ù†ÙØ±Ø¯Ø©
            name = name.replace(/\bØ§Ù„\b/g, ' ');
            name = name.replace(/\s+/g, ' ').trim();
            return name;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø¹Ø¯Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø© Ø¨Ø¯Ù‚Ø©)
        function extractFieldsFromText(spokenText) {
            let text = convertSpokenNumbers(spokenText);
            text = text.replace(/\s+/g, ' ').trim();

            let mobile = '', idCard = '', count = '', wife = '';
            let remainingText = text;

            // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬ÙˆØ§Ù„
            const mobileMatch = extractNumberWithSpaces(remainingText, { startDigit: '7', exactLength: 9 });
            if (mobileMatch) {
                mobile = mobileMatch.clean;
                remainingText = remainingText.replace(mobileMatch.raw, '');
            }

            // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            const idMatch = extractNumberWithSpaces(remainingText, { minLength: 4, maxLength: 15 });
            if (idMatch) {
                idCard = idMatch.clean;
                remainingText = remainingText.replace(idMatch.raw, '');
            }

            // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ø¯Ø¯
            const countMatch = extractCount(remainingText);
            if (countMatch) {
                count = countMatch.value;
                remainingText = remainingText.replace(countMatch.matchText, '');
            }

            // 4. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø©: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆÙ†Ø£Ø®Ø° Ø§Ù„Ù†Øµ Ø­ØªÙ‰ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£Ùˆ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø±
            const wifePatterns = [
                /(?:Ø§Ø³Ù…\s+)?Ø§Ù„Ø²ÙˆØ¬Ø©\s*(.*?)(?=\s*(?:Ø§Ù„Ø¹Ø¯Ø¯|Ø±Ù‚Ù…|Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©|Ø§Ù„Ø¬ÙˆØ§Ù„|$))/i,
                /(?:Ø§Ø³Ù…\s+)?Ø§Ù„Ø²ÙˆØ¬Ù‡\s*(.*?)(?=\s*(?:Ø§Ù„Ø¹Ø¯Ø¯|Ø±Ù‚Ù…|Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©|Ø§Ù„Ø¬ÙˆØ§Ù„|$))/i,
                /Ø²ÙˆØ¬Ø©\s*(.*?)(?=\s*(?:Ø§Ù„Ø¹Ø¯Ø¯|Ø±Ù‚Ù…|Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©|Ø§Ù„Ø¬ÙˆØ§Ù„|$))/i,
                /Ø²ÙˆØ¬Ù‡\s*(.*?)(?=\s*(?:Ø§Ù„Ø¹Ø¯Ø¯|Ø±Ù‚Ù…|Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©|Ø§Ù„Ø¬ÙˆØ§Ù„|$))/i
            ];

            for (let pattern of wifePatterns) {
                const match = pattern.exec(remainingText);
                if (match) {
                    wife = match[1].trim(); // Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† remainingText (Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© + Ø§Ù„Ø§Ø³Ù…)
                    remainingText = remainingText.replace(match[0], '');
                    break;
                }
            }

            // 5. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø§ ØªØ¨Ù‚Ù‰)
            let husband = cleanName(remainingText);

            // 6. ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯
            if (wife) {
                wife = cleanName(wife);
            }

            return { name: husband, wife, count, idCard, mobile };
        }

        // -------------------- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ --------------------
        function addDataToTable(data) {
            const row = findFirstEmptyRow();
            if (row) {
                // Ø§Ù„ØªØ±ØªÙŠØ¨: index[0], name[1], wife[2], count[3], idCard[4], mobile[5], delete[6]
                if (data.name) row.cells[1].textContent = data.name;
                if (data.wife) row.cells[2].textContent = data.wife;
                if (data.count) row.cells[3].textContent = data.count;
                if (data.idCard) row.cells[4].textContent = data.idCard;
                if (data.mobile) row.cells[5].textContent = data.mobile;
            }
        }

        // -------------------- Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ --------------------
        if (recognition) {
            recognition.onstart = function() {
                isListening = true;
                indicator.classList.add('listening');
                livePreview.innerHTML = 'ğŸŸ¢ Ø£Ù†ØµØª ...';
                finalTranscript = '';
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                livePreview.innerHTML = finalTranscript + '<span style="color: #ffd966;">' + interimTranscript + '</span>';
            };

            recognition.onend = function() {
                indicator.classList.remove('listening');
                if (finalTranscript.trim() !== '') {
                    const fields = extractFieldsFromText(finalTranscript.trim());
                    addDataToTable(fields);
                    livePreview.innerHTML = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø©: ' + finalTranscript;
                } else {
                    livePreview.innerHTML = 'âºï¸ ... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†';
                }
                isListening = false;
                finalTranscript = '';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«';
            };

            recognition.onerror = function(event) {
                console.error('Ø®Ø·Ø£:', event.error);
                indicator.classList.remove('listening');
                livePreview.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + event.error;
                isListening = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«';
            };
        }

        // Ø¨Ø¯Ø¡ / Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯Ø«
        startBtn.addEventListener('click', function() {
            if (!recognition) {
                alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ');
                return;
            }
            if (isListening) {
                recognition.stop();
                startBtn.innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯Ø«';
            } else {
                recognition.start();
                startBtn.innerHTML = '<i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯Ø«';
            }
        });

        // ØªØµØ¯ÙŠØ± Word
        exportBtn.addEventListener('click', function() {
            const table = document.getElementById('dataTable');
            const htmlContent = `
            <html dir="rtl">
            <head><meta charset="UTF-8"><title>ÙƒØ´ÙˆÙØ§Øª Ø°ÙƒÙŠØ©</title>
            <style>body { font-family: 'Cairo'; } table { border-collapse: collapse; width:100%; } th { background:#2a6df4; color:white; } td,th { border:1px solid black; padding:8px; } </style>
            </head>
            <body>${table.outerHTML}</body>
            </html>`;
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ÙƒØ´ÙˆÙØ§Øª_ØµÙˆØªÙŠ.doc';
            link.click();
        });

        // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        clearBtn.addEventListener('click', function() {
            tbody.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                appendEmptyRow(i);
            }
        });

        // Ù…Ù†Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
        tbody.addEventListener('input', function(e) {
            const cell = e.target;
            const field = cell.getAttribute('data-field');
            if (field === 'name' || field === 'wife') {
                cell.textContent = cell.textContent.replace(/\d+/g, '');
            }
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
        initTable();
    })();
</script>
</body>
</html>
